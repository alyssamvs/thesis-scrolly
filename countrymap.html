<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Drug Trafficking Routes - Geographic Network</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            background: #f8f9fa;
        }
        
        .container {
            max-width: 100vw;
            max-height: 100vh;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f1f3f4;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .metric-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .year-filter {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 300px;
        }
        
        .year-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        
        .slider-track {
            position: relative;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            flex: 1;
        }
        
        .slider-range {
            position: absolute;
            height: 6px;
            background: #767676;
            border-radius: 3px;
        }
        
        .year-slider {
            position: absolute;
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            outline: none;
            pointer-events: none;
        }
        
        .year-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #767676;
            cursor: pointer;
            border-radius: 50%;
            pointer-events: auto;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .year-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #767676;
            cursor: pointer;
            border-radius: 50%;
            pointer-events: auto;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .year-display {
            font-weight: bold;
            color: #767676;
            min-width: 80px;
            text-align: center;
        }
        
        .metric-btn, .reset-year-btn {
            padding: 8px 16px;
            border: 2px solid #767676;
            background: white;
            color: #767676;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .metric-btn.active {
            background: #767676;
            color: white;
        }
        
        .metric-btn:hover, .reset-year-btn:hover {
            transform: translateY(-1px);
            background: #767676;
            color: white;
        }
        
        .stats {
            font-size: 14px;
            color: #666;
        }
        
        .country {
            fill: #e0e0e0;
            stroke: #fff;
            stroke-width: 0.5px;
        }
        
        .country:hover {
            fill: #d0d0d0;
        }
        
        .route {
            fill: none;
            stroke-opacity: 0.5;
            stroke-linecap: round;
        }
        
        .route:hover {
            stroke-opacity: 0.9;
            stroke-width: 4px !important;
        }
        
        .node-circle {
            cursor: pointer;
            stroke: #fff;
            stroke-width: 2px;
        }
        
        .node-circle:hover {
            stroke: #333;
            stroke-width: 3px;
        }
        
        .node-label {
            pointer-events: none;
            text-anchor: middle;
            font-size: 10px;
            font-weight: bold;
            fill: #333;
            text-shadow: 1px 1px 2px white, -1px -1px 2px white;
        }
        
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .legend {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .legend h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .legend-item {
            margin: 5px 0;
            font-size: 13px;
            color: #666;
        }
        
        .zoom-controls {
            position: absolute;
            top: 80px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 100;
        }
        
        .zoom-btn {
            padding: 8px 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .zoom-btn:hover {
            background: #0056b3;
        }
        
        #chart {
            position: relative;
            background: #f0f8ff;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
               
        <div class="controls">
            <div class="metric-selector">
                
                <button class="metric-btn active" onclick="switchMetric('seizure_count')">Number of Seizures</button>
                <button class="metric-btn" onclick="switchMetric('total_quantity_kg')">Total Quantity (kg)</button>
            </div>
            
            <div class="year-filter">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span><strong>Year Range:</strong></span>
                    <span class="year-display" id="year-range-display">2011 - 2016</span>
                    <button class="reset-year-btn" onclick="resetYearFilter()">All Years</button>
                </div>
                <div class="year-slider-container">
                    <span style="font-size: 12px; color: #666;">2011</span>
                    <div class="slider-track">
                        <div class="slider-range" id="slider-range"></div>
                        <input type="range" min="2011" max="2016" value="2011" class="year-slider" id="year-start" oninput="updateYearFilter()">
                        <input type="range" min="2011" max="2016" value="2016" class="year-slider" id="year-end" oninput="updateYearFilter()">
                    </div>
                    <span style="font-size: 12px; color: #666;">2016</span>
                </div>
            </div>
            
            <div class="stats" id="network-stats">
                Loading data...
            </div>
        </div>
        
        <div id="chart">
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()">+</button>
                <button class="zoom-btn" onclick="zoomOut()">−</button>
                <button class="zoom-btn" onclick="resetZoom()">⌂</button>
            </div>
        </div>
        
        <div class="legend">
                       <div class="legend-item"><strong>Node Size:</strong> Based on total connections (hub countries are larger)</div>
            <div class="legend-item"><strong>Route Thickness:</strong> Based on selected metric (seizures or quantity)</div>
            <div class="legend-item"><strong>Route Color:</strong> Gradient from red (low volume) to dark red (high volume)</div>
            <div class="legend-item"><strong>Year Filter:</strong> Shows routes active during any part of the selected year range</div>
            <div class="legend-item"><strong>Interaction:</strong> Hover over routes and nodes for details, zoom with controls or mouse wheel</div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Global variables
        var globalData = [];
        var currentMetric = 'seizure_count';
        var yearStart = 2011;
        var yearEnd = 2016;
        var svg, g, projection, path;
        var zoom;
        var countryCoordinates;

        // Chart setup
        var width = 1400;
        var height = 700;

        // Create projection - Mercator centered on Atlantic (good for viewing trafficking routes)
        projection = d3.geoMercator()
            .scale(200)
            .center([0, 20])
            .translate([width / 2, height / 2]);

        path = d3.geoPath().projection(projection);

        function initChart() {
            svg = d3.select("#chart")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            // Add zoom behavior
            zoom = d3.zoom()
                .scaleExtent([1, 8])
                .on("zoom", function(event) {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom);

            g = svg.append("g");
        }

        var tooltip = d3.select("#tooltip");

        // Load country coordinates
        function loadCountryCoordinates() {
            return d3.json('./data/country_coordinates.json');
        }

        // Load world map from CDN
        function loadWorldMap() {
            return d3.json('https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json');
        }

        // Year filter functions
        function updateYearFilter() {
            var startSlider = document.getElementById('year-start');
            var endSlider = document.getElementById('year-end');
            
            var start = parseInt(startSlider.value);
            var end = parseInt(endSlider.value);
            
            // Ensure start is not greater than end
            if (start > end) {
                if (event.target.id === 'year-start') {
                    startSlider.value = end;
                    start = end;
                } else {
                    endSlider.value = start;
                    end = start;
                }
            }
            
            yearStart = start;
            yearEnd = end;
            
            // Update visual range indicator
            updateSliderRange();
            
            document.getElementById('year-range-display').textContent = yearStart + ' - ' + yearEnd;
            updateVisualization();
        }
        
        function updateSliderRange() {
            var rangeDiv = document.getElementById('slider-range');
            var startPercent = ((yearStart - 2011) / (2016 - 2011)) * 100;
            var endPercent = ((yearEnd - 2011) / (2016 - 2011)) * 100;
            
            rangeDiv.style.left = startPercent + '%';
            rangeDiv.style.width = (endPercent - startPercent) + '%';
        }
        
        function resetYearFilter() {
            document.getElementById('year-start').value = 2011;
            document.getElementById('year-end').value = 2016;
            yearStart = 2011;
            yearEnd = 2016;
            updateSliderRange();
            document.getElementById('year-range-display').textContent = '2011 - 2016';
            updateVisualization();
        }

        // Check if a route is active during the selected year range
        function isRouteInYearRange(route) {
            var routeStart = parseInt(route.first_year);
            var routeEnd = parseInt(route.last_year);
            
            // Route is active if there's ANY overlap with selected range
            return routeEnd >= yearStart && routeStart <= yearEnd;
        }

        // Process data function
        function processData(data, metric) {
            console.log("Processing", data.length, "routes for geographic network");
            
            // Filter by seizure count, valid coordinates, and year range
            var filteredData = data.filter(function(d) {
                return d.seizure_count > 3 && 
                       d.DEPARTURE_COUNTRY !== d.DESTINATION_COUNTRY &&
                       countryCoordinates[d.DEPARTURE_COUNTRY] && 
                       countryCoordinates[d.DESTINATION_COUNTRY] &&
                       isRouteInYearRange(d);
            });
            
            console.log("After filtering:", filteredData.length, "routes for years", yearStart, "-", yearEnd);
            
            // Create nodes from unique countries
            var nodeMap = new Map();
            var nodes = [];
            
            filteredData.forEach(function(d) {
                [d.DEPARTURE_COUNTRY, d.DESTINATION_COUNTRY].forEach(function(country) {
                    if (!nodeMap.has(country)) {
                        var coords = countryCoordinates[country];
                        var projected = projection([coords.lon, coords.lat]);
                        var node = {
                            id: country,
                            name: country,
                            lat: coords.lat,
                            lon: coords.lon,
                            x: projected[0],
                            y: projected[1],
                            totalSeizures: 0,
                            totalQuantity: 0,
                            connections: 0
                        };
                        nodeMap.set(country, node);
                        nodes.push(node);
                    }
                });
            });
            
            // Calculate node sizes based on total activity
            filteredData.forEach(function(d) {
                var source = nodeMap.get(d.DEPARTURE_COUNTRY);
                var target = nodeMap.get(d.DESTINATION_COUNTRY);
                
                if (source && target) {
                    source.totalSeizures += d.seizure_count;
                    source.totalQuantity += d.total_quantity_kg;
                    source.connections += 1;
                    
                    target.totalSeizures += d.seizure_count;
                    target.totalQuantity += d.total_quantity_kg;
                    target.connections += 1;
                }
            });

            // Create routes (links)
            var routes = filteredData.map(function(d) {
                var source = nodeMap.get(d.DEPARTURE_COUNTRY);
                var target = nodeMap.get(d.DESTINATION_COUNTRY);
                
                return {
                    source: source,
                    target: target,
                    value: d[metric],
                    seizure_count: d.seizure_count,
                    total_quantity_kg: d.total_quantity_kg,
                    departure: d.DEPARTURE_COUNTRY,
                    destination: d.DESTINATION_COUNTRY,
                    first_year: d.first_year,
                    last_year: d.last_year
                };
            });

            return {nodes: nodes, routes: routes};
        }

        // Create curved path for routes
        function createRoutePath(d) {
            var dx = d.target.x - d.source.x;
            var dy = d.target.y - d.source.y;
            var dr = Math.sqrt(dx * dx + dy * dy) * 0.8; // Curve radius
            
            // Create curved path
            return "M" + d.source.x + "," + d.source.y + 
                   "A" + dr + "," + dr + " 0 0,1 " + 
                   d.target.x + "," + d.target.y;
        }

        // Update visualization
        function updateVisualization() {
            if (globalData.length === 0 || !countryCoordinates) {
                console.log("Waiting for data...");
                return;
            }

            // Clear previous routes and nodes (keep map)
            g.selectAll(".route").remove();
            g.selectAll(".node-circle").remove();
            g.selectAll(".node-label").remove();

            var processed = processData(globalData, currentMetric);
            console.log("Creating map with", processed.nodes.length, "nodes and", processed.routes.length, "routes");

            // Create scales
            var maxValue = d3.max(processed.routes, function(d) { return d.value; });
            var routeScale = d3.scaleLinear()
                .domain([0, maxValue])
                .range([0.5, 8]);

            var maxConnections = d3.max(processed.nodes, function(d) { return d.connections; });
            var nodeScale = d3.scaleLinear()
                .domain([0, maxConnections])
                .range([4, 20]);

            // Add routes
            var route = g.append("g")
                .attr("class", "routes-layer")
                .selectAll(".route")
                .data(processed.routes)
                .enter().append("path")
                .attr("class", "route")
                .attr("d", createRoutePath)
                .attr("stroke", function(d) {
                    // Color gradient based on volume
                    var intensity = d.value / maxValue;
                    return d3.interpolateReds(0.3 + intensity * 0.6);
                })
                .attr("stroke-width", function(d) { return routeScale(d.value); })
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("stroke-opacity", 0.9);
                    tooltip
                        .style("opacity", 1)
                        .html("<strong>" + d.departure + " → " + d.destination + "</strong><br/>" +
                              "Years Active: " + d.first_year + " - " + d.last_year + "<br/>" +
                              "Seizures: " + d.seizure_count.toLocaleString() + "<br/>" +
                              "Total Quantity: " + d.total_quantity_kg.toLocaleString() + " kg<br/>" +
                              "Avg per Seizure: " + (d.total_quantity_kg / d.seizure_count).toFixed(2) + " kg")
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("stroke-opacity", 0.5);
                    tooltip.style("opacity", 0);
                });

            // Add nodes
            var node = g.append("g")
                .attr("class", "nodes-layer")
                .selectAll(".node-circle")
                .data(processed.nodes)
                .enter().append("circle")
                .attr("class", "node-circle")
                .attr("cx", function(d) { return d.x; })
                .attr("cy", function(d) { return d.y; })
                .attr("r", function(d) { return nodeScale(d.connections); })
                .attr("fill", function(d) { 
                    // Color by connection intensity
                    var intensity = d.connections / maxConnections;
                    return d3.interpolateOranges(0.4 + intensity * 0.5);
                })
                .on("mouseover", function(event, d) {
                    tooltip
                        .style("opacity", 1)
                        .html("<strong>" + d.name + "</strong><br/>" +
                              "Connections: " + d.connections + "<br/>" +
                              "Total Seizures: " + d.totalSeizures.toLocaleString() + "<br/>" +
                              "Total Quantity: " + d.totalQuantity.toLocaleString() + " kg")
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("opacity", 0);
                });

            // Add labels for major hubs (top 20)
            var sortedNodes = processed.nodes.slice().sort(function(a, b) { 
                return b.connections - a.connections; 
            });
            var topNodes = sortedNodes.slice(0, 20);

            var labels = g.append("g")
                .attr("class", "labels-layer")
                .selectAll(".node-label")
                .data(topNodes)
                .enter().append("text")
                .attr("class", "node-label")
                .attr("x", function(d) { return d.x; })
                .attr("y", function(d) { return d.y + nodeScale(d.connections) + 12; })
                .text(function(d) { return d.name; })
                .style("font-size", function(d) { 
                    return Math.min(11, Math.max(8, nodeScale(d.connections) / 1.5)) + "px"; 
                });

            // Update stats
            var yearText = (yearStart === 2011 && yearEnd === 2016) ? 
                'All years (2011-2016)' : 
                'Years ' + yearStart + '-' + yearEnd;
            
            document.getElementById('network-stats').textContent = 
                processed.routes.length + ' routes • ' + 
                processed.nodes.length + ' countries • ' +
                yearText;
        }

        // Zoom functions
        function zoomIn() {
            svg.transition().call(zoom.scaleBy, 1.5);
        }

        function zoomOut() {
            svg.transition().call(zoom.scaleBy, 1 / 1.5);
        }

        function resetZoom() {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        }

        // Switch metric function
        function switchMetric(metric) {
            currentMetric = metric;
            
            // Update button states
            document.querySelectorAll('.metric-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update visualization
            updateVisualization();
        }

        // Initialize
        function init() {
            initChart();
            
            // Load all data
            Promise.all([
                loadWorldMap(),
                loadCountryCoordinates(),
                d3.csv('./data/seizures_routing_network_data.csv')
            ]).then(function([worldData, coordinates, csvData]) {
                console.log("All data loaded successfully");
                
                countryCoordinates = coordinates;
                
                // Convert strings to numbers in CSV
                csvData.forEach(function(d) {
                    d.seizure_count = +d.seizure_count;
                    d.total_quantity_kg = +d.total_quantity_kg;
                    d.first_year = d.first_year;
                    d.last_year = d.last_year;
                });
                
                globalData = csvData;
                
                // Draw world map
                var countries = topojson.feature(worldData, worldData.objects.countries);
                
                g.append("g")
                    .attr("class", "countries")
                    .selectAll(".country")
                    .data(countries.features)
                    .enter().append("path")
                    .attr("class", "country")
                    .attr("d", path);
                
                // Draw network
                updateVisualization();
                
                // Initialize slider range display
                updateSliderRange();
                
            }).catch(function(error) {
                console.error("Error loading data:", error);
                document.getElementById('network-stats').textContent = "Error loading data: " + error.message;
            });
        }

        // Start
        init();
    </script>
</body>
</html>